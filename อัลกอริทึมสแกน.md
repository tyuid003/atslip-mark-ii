1. ต่อไปเราจะทำ logic อัลกอริทึมการสแกน โดยที่จะใช้ ทั้งLine OA webhook และการอัพโหลดเชื่อมต่อใน อัลกอริทึมตัวเดียวกัน แต่เราจะเริ่มจาก อัพโหลดก่อน โดยฉันจะอธิบาย logic แบบระเอียดช่วยเขียน อัลกอริทึมตามที่ฉันบอกเป๊ะๆ ไม่ตกหล่น

# หน้าเว็บ
- ผู้ใช้อัพโหลดสลิป (อัพโหลดแล้วทำงานทันทีไม่ต้องกดปุ่มอะไร)
- ส่งไปที่อัลกอริทึมสแกน

# ฟังชั่นอัลกอริทึมสแกน
- ส่งสลิปไป ให้ EASYSLIP รูปแบบ FILE หรือ image (วิธีการใช้งาน EASYSLIP อยู่ใน EASYSLIP.MD)

ตัวอย่าง data ที่ได้จากการสแกน EASYSLIP
{
    "success": true,
    "data": {
        "status": 200,
        "data": {
            "payload": "004600060000010103002022520260228154720240040847085102TH91040487",
            "transRef": "2026022815472024004084708",
            "date": "2026-02-28T15:47:20+07:00",
            "countryCode": "",
            "amount": {
                "amount": 100,
                "local": {
                    "amount": 0,
                    "currency": ""
                }
            },
            "fee": 0,
            "ref1": "",
            "ref2": "",
            "ref3": "",
            "sender": {
                "bank": {
                    "id": "002",
                    "name": "ธนาคารกรุงเทพ",
                    "short": "BBL"
                },
                "account": {
                    "name": {
                        "th": "MR SOMSAK M",
                        "en": "MR SOMSAK M"
                    },
                    "bank": {
                        "type": "BANKAC",
                        "account": "347-0-xxx165"
                    }
                }
            },
            "receiver": {
                "bank": {
                    "id": "030",
                    "name": "ธนาคารออมสิน",
                    "short": "GSB"
                },
                "account": {
                    "name": {
                        "th": "นางสาว บุญศรี ช",
                        "en": "Boonsri C"
                    },
                    "bank": {
                        "type": "BANKAC",
                        "account": "020-4-xxx92133"
                    }
                }
            }
        }
    }
}

- รับ Response จาก EASYSLIP ตรงนี้สำคัญ จะต้องค้นหาจาก 

1.ธนาตารผู้รับโอน(อันนี้ค่อนข้างยากต้องเทสก่อนเพราะว่าชื่อธนาคารอาจไม่ตรงกัน เช่น กสิกร , กสิกรไทย , ธนาคารกสิกรไทย , Kbank ) ถ้าหากไม่พบให้ Try ข้อ 2 , 3

2.เลขบัญชีผู้รับโอน (ตำแหน่งไหนก็ได้ขั้นต่ำ 3 ตัว)

3.ชื่อผู้รับ การ match จะต้องตัดคำนำหน้าออก เช่น นาย , นาง , นางสาว , น.ส. , เด็กชาย , เด็กหญิง นอกจากนั้นแล้วจะต้องเก็บทั้งชื่อไทยและอังกฤษในข้อมูลที่ได้จาก EASYSLIP เนื่องจากลูกค้าบางคนใช้ภาษาไทยและอังกฤษ การ match ต้อง try ทั้งสองภาษา
ตัวอย่างข้อมุลจริงที่ได้จาก easyslip
                        "th": "นางสาว บุญศรี ช",
                        "en": "Boonsri C"

 จากนั้น match โดยให้ตรงกัน 4 ตัวขึ้นไปกับบัญชีของ tenant ใน KV หากพบว่าตรงกับ tenant ไหน ให้บันทึก pending_transactions ใน tenant นั้นๆ
 
เมื่อ match บัญชี receiver ซึ่งเป็นบัญชีของ tenant แล้ว 

# match บัญชี sender ซึ่งเป็นผู้โอน ด้วย
โดยการเก็บ ทั้งชื่อไทยและอังกฤษ เช่นกันกับ  receiver

จากนั้นค้นหาโดยใช้ API GET

https://{base_api_admin_url}/api/users/list?page=1&limit=100&search=%E0%B8%A5%E0%B8%B2%E0%B8%A0%E0%B8%97%E0%B8%A7%E0%B8%B5&userCategory=member

ตัวอย่าง Response
{
    "message": "Success",
    "list": [
        {
            "id": 6831,
            "userTypeId": 2,
            "phone": "0632204239",
            "loginType": "phone",
            "totalDepositAmount": 0,
            "depositRank": "",
            "totalTurnOverAmount": 0,
            "turnOverRank": "",
            "memberCode": "zta70f11008043",
            "refBy": "",
            "refUrl": "https://hengdragon66.com/register?ref=xiJxoCpeNM",
            "fullname": "ลาภทวี โพธิ์อ่อง",
            "type": "AFFILIATE",
            "bankId": 1,
            "bankName": "กสิกรไทย",
            "bankAccount": "371586938",
            "channelId": 0,
            "channel": "",
            "credit": 55,
            "note": "",
            "ip": "103.132.3.70",
            "ipRegistered": "",
            "createdBy": "taeheng66",
            "createdAt": "2026-02-14T09:37:28Z",
            "updatedAt": "2026-02-25T11:12:02Z",
            "logedinAt": "2026-02-25T11:11:26Z",
            "accumulatedAmount": 3000,
            "maximumTimePerDay": 5
        }
    ],
    "total": 1
}

และถ้าหากไม่พบข้อมูล จะได้ response
{"message":"Success","list":null,"total":0}
แล้วให้ try อีกครั้งโดยใช้ non-member

 ตัวอย่าง API GET
 
https://{base_api_admin_url}}/api/users/list?page=1&limit=100&search=%E0%B8%81%E0%B8%A4%E0%B8%95%E0%B8%A0%E0%B8%B2%E0%B8%AA+%E0%B8%88%E0%B8%B4&userCategory=non-member

ตัวอย่าง response
{
    "message": "Success",
    "list": [
        {
            "id": 10611,
            "userTypeId": 1,
            "phone": "0639594641",
            "loginType": "phone",
            "totalDepositAmount": 0,
            "depositRank": "",
            "totalTurnOverAmount": 0,
            "turnOverRank": "",
            "memberCode": "",
            "refBy": "zta70f11008353",
            "refUrl": "https://hengdragon66.com/register?ref=n0eZqfPa3C",
            "fullname": "กฤตภาส จิตต์ถนอม",
            "type": "NONE",
            "bankId": 20,
            "bankName": "TrueMoney Wallet",
            "bankAccount": "0639594641",
            "channelId": 0,
            "channel": "พันธมิตร",
            "credit": 0,
            "note": "",
            "ip": "2001:44c8:6561:298b:",
            "ipRegistered": "49.230.85.252",
            "createdBy": "",
            "createdAt": "2026-02-28T08:57:28Z",
            "updatedAt": "2026-02-28T08:57:29Z",
            "logedinAt": "2026-02-28T08:57:29Z",
            "accumulatedAmount": 3000,
            "maximumTimePerDay": 5
        }
    ],
    "total": 1
}
 
หากพบข้อมูล จะไปทริกเกอร์ให้ ฟังชั่น deposit ทำงาน (เราจะสร้างในขั้นตอนต่อไป เป็นอีกไฟล์ แต่ตอนนี้ช่วยเขียนอัลกอริทึมสแกนก่อนเพราะค่อนข้างน่าจะยาว)